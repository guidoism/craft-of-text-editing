<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-02-27 Mon 12:41 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‎</title>
<meta name="author" content="Guido Bartolucci" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="plaintexcss.css" />
</head>
<body>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org6aecbe7">0.1. Buffers</a>
<ul>
<li><a href="#orgb375025">0.1.1. Buffer Representation</a></li>
<li><a href="#orged5b748">0.1.2. Create a new buffer</a></li>
<li><a href="#org2afc933">0.1.3. Insert a character</a></li>
</ul>
</li>
<li><a href="#org63c91ee">0.2. Events</a>
<ul>
<li><a href="#orga3acd8a">0.2.1. Initialize Everything</a></li>
<li><a href="#org24b4652">0.2.2. Load Fonts</a></li>
<li><a href="#orge42845b">0.2.3. Handle Event</a></li>
</ul>
</li>
<li><a href="#org6faf191">0.3. Display</a>
<ul>
<li><a href="#orgfd3ad18">0.3.1. Typeset Buffer</a></li>
<li><a href="#orga767b37">0.3.2. Display State</a></li>
<li><a href="#orgff09dac">0.3.3. Draw Frame</a></li>
</ul>
</li>
<li><a href="#org66e16b2">0.4. TextMode vs Graphics</a>
<ul>
<li><a href="#org94611c4">0.4.1. Unicode Helpers</a></li>
</ul>
</li>
<li><a href="#orgec05629">0.5. Extensions</a>
<ul>
<li><a href="#orgb6ae402">0.5.1. Lisp Nodes</a></li>
</ul>
</li>
<li><a href="#org3c9bbaf">0.6. Stupid Ideas</a></li>
<li><a href="#orga5008ba">0.7. Questions</a></li>
</ul>
</li>
<li><a href="#org8b74ba3">1. Exporting</a>
<ul>
<li>
<ul>
<li><a href="#orgef41ab9">1.0.1. Bailing wire and duct tape</a></li>
<li><a href="#org2cd6687">1.0.2. Shit that doesn’t work</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
This is a text editor in the style of Emacs. It has been written from
scratch in a literate form with help from Craig A. Finseth’s book <a href="https://www.finseth.com/craft/">The
Craft of Text Editing –or– Emacs for the Modern World</a>. We have
written in in Org-mode using a tweaked Vincent Dörig’s <a href="https://latex.vercel.app">latex.css</a>
and <a href="https://github.com/StylishThemes/Syntax-Themes/tree/master/pygments">css’d pygments</a> to make the weaved output look pretty.
</p>

<p>
Our motivation is to be able to learn how a actually-usable non-toy
text editor works by reading the source code and commentary in a
narrative fashion. At certain points along the way we will have a
working editor that can be tangled, compiled, and run. Over time
certain parts will be enhanced or replaced with something more
advanced. The intent is for the reader take a bit at a time and not
forced to choose between either grokking whole complexity all at one
or seeing non-working toy parts.
</p>

<p>
We will start with a discussion and definition of buffers as this is a
foundational concept in Emacs. We will turn this simple buffer into an
editor by adding: 1. The ability to add a character to the buffer one
at a time, 2. The ability to transform the buffer into something that
can be seen, and 3. The ability to read in input from the user.
</p>

<p>
Next we will turn out editor into something that takes control of the
whole screen by using <a href="https://github.com/floooh/sokol">Sokol</a> to provide cross-platform access to the
graphical display subsystems of our operating system.
</p>

<p>
At this point we know have full control over our display so we can
add the following features:
</p>

<ul class="org-ul">
<li>Typeset characters in their proper place</li>
<li>Add a status bar to the bottom</li>
<li>Make a cursor</li>
</ul>

<div id="outline-container-org6aecbe7" class="outline-3">
<h3 id="org6aecbe7"><span class="section-number-3">0.1.</span> Buffers</h3>
<div class="outline-text-3" id="text-0-1">
<p>
Everything is a buffer. That statement is not quite true, but it’s
true enough. Files that we edit are loading into a buffer. When we
start a new file we start with an empty buffer and later bind it to
and save it to a file. Commands are typed into a (mini-) buffer.
Background status is stored in buffers. This is the magic that makes
Emacs so hackable.
</p>

<p>
A text file is a one-dimensional representation of a two-dimensional
document. For example, newlines are control characters that describe
how to convert the file into the 2d plane of glyphs.
</p>

<p>
This is an important point to remember. There’s nothing sacred about
drawing one character at a time, from left to right, and when we get
to the right of the display wrapping to the next line by moving down
the glyph height and starting again at the far left and doing the
same when we reach a newline character instead of drawing it.
</p>

<p>
Painting a sequence of glyphs across the screen in a zig-zag is pretty
universal for text, but the direction you move isn’t.
</p>

<p>
In fact, we will almost certainly want to visualize a sequence of
characters in different ways. For example: wrapping long lines vs
truncation.
</p>

<p>
And this brings up another difference, do we want the cursor to move
around the screen without any regard to the structure of the text
under it or does “move up” for example really mean move to the
previous line at the same column offset? And what happens if the
previous line is too short and doesn’t have that column? And what
happens if you keep moving up and encounter another line that <i>is</i>
long enough? 
</p>

<p>
Mentally de-coupling the sequence of characters in a buffer with the
visualization opens up other potential improvements. Maybe we can also
display a PDF as either the textual format or as the drawn document
the author intended. Or we could constrain code files to always be
syntactically correct.
</p>
</div>

<div id="outline-container-orgb375025" class="outline-4">
<h4 id="orgb375025"><span class="section-number-4">0.1.1.</span> Buffer Representation</h4>
<div class="outline-text-4" id="text-0-1-1">
<p>
The choice of data structure for a buffer of text is dependent several
factors most notably how much text, whether it is full of many short
lines or few long lines, and whether it will be mostly just read or is
under active editing.
</p>

<p>
We recognized that we don’t have to use the same data structure for
all active buffer nor even the same data structure for the buffer over
its lifetime.
</p>
</div>

<ol class="org-ol">
<li><a id="org2814707"></a>Gap Buffers<br />
<div class="outline-text-5" id="text-0-1-1-1">
<p>
In the actual implementation they use Gap Buffers. A buffer
initial starts off all gap, the first part is 0 length at
the beginning and the second part is 0 length at the end.
</p>
</div>
</li>

<li><a id="org9f4adaf"></a>Naïve Buffer<br />
<div class="outline-text-5" id="text-0-1-1-2">
<p>
Before we implement the more complex gap buffer we will
implement the most naïve form of buffer. Just a flat piece
of memory that comes from malloc. We move everything after
the insertion point with <code>memmove</code> during each edit.
</p>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Buffer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">BufferId</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="o">*</span><span class="w"> </span><span class="n">contents</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">point</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">line_count</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">line_starts</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="p">}</span><span class="w"> </span><span class="n">Buffer</span><span class="p">;</span><span class="w"></span>

<span class="n">Buffer</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="w"></span>
<span class="n">u16</span><span class="w"> </span><span class="n">buffers_len</span><span class="p">;</span><span class="w"></span>
<span class="n">BufferId</span><span class="w"> </span><span class="n">current_buffer_id</span><span class="p">;</span><span class="w"></span>
</pre></div>

</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orged5b748" class="outline-4">
<h4 id="orged5b748"><span class="section-number-4">0.1.2.</span> Create a new buffer</h4>
<div class="outline-text-4" id="text-0-1-2">
<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="n">Status</span><span class="w"> </span><span class="nf">create_buffer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buffers_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Failure</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffers_len</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Buffer</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_starts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">4096</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Success</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Status</span><span class="w"> </span><span class="nf">set_current_buffer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buffers_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">current_buffer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Failure</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>

<div id="outline-container-org2afc933" class="outline-4">
<h4 id="org2afc933"><span class="section-number-4">0.1.3.</span> Insert a character</h4>
<div class="outline-text-4" id="text-0-1-3">
<p>
Insert the character that has been typed.
</p>

<p>
The universal argument is assumed to be the number of times to repeat
the character being inserted.
</p>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="n">Status</span><span class="w"> </span><span class="nf">insert_char</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">contents</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">point</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Inserting %d to location %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="w"> </span><span class="n">enc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_utf8</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">NotUnicode</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">memmove</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">+</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="n">enc</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">point</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">length</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Success</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>
</div>

<div id="outline-container-org63c91ee" class="outline-3">
<h3 id="org63c91ee"><span class="section-number-3">0.2.</span> Events</h3>
<div class="outline-text-3" id="text-0-2">
<p>
Now we move on to the human scale. This is where we react to keys
being pressed or being told that we need to re-draw the display.
</p>
</div>

<div id="outline-container-orga3acd8a" class="outline-4">
<h4 id="orga3acd8a"><span class="section-number-4">0.2.1.</span> Initialize Everything</h4>
<div class="outline-text-4" id="text-0-2-1">
<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">create_buffer</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;*scratch*&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">set_current_buffer</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;*scratch*&quot;</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">dpi_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sapp_dpi_scale</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sg_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sg_desc</span><span class="p">){.</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sapp_sgcontext</span><span class="p">(),</span><span class="w"> </span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">__dbgui_setup</span><span class="p">(</span><span class="n">sapp_sample_count</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sgl_desc_t</span><span class="p">){.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">});</span><span class="w"></span>

<span class="w">  </span><span class="c1">// make sure the fontstash atlas width/height is pow-2</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">atlas_dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round_pow2</span><span class="p">(</span><span class="mf">512.0f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">dpi_scale</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sfons_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfons_desc_t</span><span class="p">){.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atlas_dim</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atlas_dim</span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">font_mono</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FONS_INVALID</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">font_normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FONS_INVALID</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">sfetch_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_desc_t</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">num_channels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">num_lanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">sfetch_send</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_request_t</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/guido/Library/Fonts/MinionPro-Regular.otf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">font_normal_loaded</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SFETCH_RANGE</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">font_normal_data</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">sfetch_send</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_request_t</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/guido/Library/Fonts/Hack Regular Nerd Font Complete.ttf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">font_mono_loaded</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SFETCH_RANGE</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">font_mono_data</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>

<div id="outline-container-org24b4652" class="outline-4">
<h4 id="org24b4652"><span class="section-number-4">0.2.2.</span> Load Fonts</h4>
<div class="outline-text-4" id="text-0-2-2">
<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="w">  </span><span class="n">sfetch_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_desc_t</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">num_channels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">num_lanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">sfetch_send</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_request_t</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/guido/Library/Fonts/MinionPro-Regular.otf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">font_normal_loaded</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SFETCH_RANGE</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">font_normal_data</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">sfetch_send</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_request_t</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/guido/Library/Fonts/Hack Regular Nerd Font Complete.ttf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">font_mono_loaded</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SFETCH_RANGE</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">font_mono_data</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="p">});</span><span class="w"></span>
</pre></div>

</div>


<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">font_mono_loaded</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sfetch_response_t</span><span class="o">*</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loading mono</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">fetched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loaded mono</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">font_mono</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsAddFontMem</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mono&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w">  </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loading mono failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">font_normal_loaded</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sfetch_response_t</span><span class="o">*</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loading normal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">fetched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loaded normal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">font_normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsAddFontMem</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sans&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w">  </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>


<div id="outline-container-orge42845b" class="outline-4">
<h4 id="orge42845b"><span class="section-number-4">0.2.3.</span> Handle Event</h4>
<div class="outline-text-4" id="text-0-2-3">
<p>
This is what happens when something like a key is pressed or the
window is re-sized.
</p>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">handle_event</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sapp_event</span><span class="o">*</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// SAPP_EVENTTYPE_KEY_DOWN</span>
<span class="w">  </span><span class="c1">// SAPP_EVENTTYPE_KEY_UP</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SAPP_EVENTTYPE_CHAR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">insert_char</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">char_code</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// bool key_repeat;</span>
<span class="w">    </span><span class="c1">// uint32_t modifiers;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>
</div>

<div id="outline-container-org6faf191" class="outline-3">
<h3 id="org6faf191"><span class="section-number-3">0.3.</span> Display</h3>
<div class="outline-text-3" id="text-0-3">
</div>
<div id="outline-container-orgfd3ad18" class="outline-4">
<h4 id="orgfd3ad18"><span class="section-number-4">0.3.1.</span> Typeset Buffer</h4>
<div class="outline-text-4" id="text-0-3-1">
<p>
This is where we translate the one-dimensional buffer into our
two-dimensional display. In anticipation of the later addition of
“windows” we will provide the ability to typeset a buffer into any
size. We will go ahead an call the display a window for now. In fact,
it makes sense to think of a window as a view into the buffer. You
aren’t necessarily going to see the whole thing.
</p>

<p>
If the buffer typesets into something smaller than the window then our
job is very easy. It gets more complicated when we have to figure out
where to place the point and then determine how far back to start
from.
</p>

<p>
Let’s try to describe the typesetting algorithm for a large buffer
and then see if that also solves our simple case.
</p>

<p>
The point is obviously kept as part as an index into the buffer. It’s
also something visual, a cursor that has a location in the window.
This relationship must be the heart of our algorithm. Let’s start
by defining our Window type.
</p>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Window</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">u16_pair</span><span class="w"> </span><span class="n">size_in_pixels</span><span class="p">;</span><span class="w">  </span><span class="c1">// in pixels</span>
<span class="w">  </span><span class="n">u16_pair</span><span class="w"> </span><span class="n">size_in_chars</span><span class="p">;</span><span class="w">   </span><span class="c1">// in characters</span>
<span class="w">  </span><span class="n">u16_pair</span><span class="w"> </span><span class="n">cursor_location</span><span class="p">;</span><span class="w"> </span><span class="c1">// in characters</span>
<span class="w">  </span>
<span class="p">}</span><span class="w"> </span><span class="n">Window</span><span class="p">;</span><span class="w"></span>
</pre></div>

</div>

<p>
Now we need to determine which location in the buffer represents the
first character of the first line in our window. The naïve approach is
what we will do first. Let’s just typeset everything from the
beginning of the buffer until our current location. Actually, it’s
simpler than that. We just need to keep track of the locations in the
buffer that represent the beginnings of lines.
</p>

<p>
Add the new entries to the Buffer struct.
</p>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="n">u64</span><span class="w"> </span><span class="n">line_count</span><span class="p">;</span><span class="w"></span>
<span class="n">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">line_starts</span><span class="p">;</span><span class="w"></span>
</pre></div>

</div>

<p>
Now allocate that space during buffer creation.
</p>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_starts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">4096</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span><span class="w"></span>
</pre></div>

</div>

<p>
Finally, we have a function for calculating the line starts for the
entire buffer.
</p>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;calculate_line_starts, length = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_starts</span><span class="p">[(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_count</span><span class="p">)</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Start of line: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>

<div id="outline-container-orga767b37" class="outline-4">
<h4 id="orga767b37"><span class="section-number-4">0.3.2.</span> Display State</h4>
<div class="outline-text-4" id="text-0-3-2">
<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">FONScontext</span><span class="o">*</span><span class="w"> </span><span class="n">fons</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">dpi_scale</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">font_mono</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">font_normal</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">font_mono_data</span><span class="p">[</span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">font_normal_data</span><span class="p">[</span><span class="mi">256</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">state_t</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">state_t</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>

<div id="outline-container-orgff09dac" class="outline-4">
<h4 id="orgff09dac"><span class="section-number-4">0.3.3.</span> Draw Frame</h4>
<div class="outline-text-4" id="text-0-3-3">
<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw_frame</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Buffer</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;calculate_line_starts, length = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_starts</span><span class="p">[(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_count</span><span class="p">)</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Start of line: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dpis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">dpi_scale</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// pump sokol_fetch message queues (GUIDO: why?)</span>
<span class="w">  </span><span class="n">sfetch_dowork</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="n">lh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">white</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sfons_rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsClearState</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">sgl_defaults</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_matrix_mode_projection</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_ortho</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_widthf</span><span class="p">(),</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.0f</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.0f</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">sx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="o">*</span><span class="n">dpis</span><span class="p">;</span><span class="w"> </span><span class="n">sy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="o">*</span><span class="n">dpis</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sx</span><span class="p">;</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sy</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">FONScontext</span><span class="o">*</span><span class="w"> </span><span class="n">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetFont</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">font_normal</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetSize</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="mf">124.0f</span><span class="o">*</span><span class="n">dpis</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsVertMetrics</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lh</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sx</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">dy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">lh</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetColor</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">white</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsDrawText</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Draw status line</span>
<span class="w">  </span><span class="n">line</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">()</span><span class="mi">-100</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_widthf</span><span class="p">(),</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">()</span><span class="mi">-100</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetFont</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">font_mono</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetSize</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="mf">48.0f</span><span class="o">*</span><span class="n">dpis</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsDrawText</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">()</span><span class="mi">-24</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;U:**-  *scratch*  0% (0,0)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// flush fontstash&#39;s font atlas to sokol-gfx texture</span>
<span class="w">  </span><span class="n">sfons_flush</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// render pass</span>
<span class="w">  </span><span class="n">sg_begin_default_pass</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sg_pass_action</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SG_ACTION_CLEAR</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.32f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">sapp_width</span><span class="p">(),</span><span class="w"> </span><span class="n">sapp_height</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_draw</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">__dbgui_draw</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sg_end_pass</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sg_commit</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>
</div>


<div id="outline-container-org66e16b2" class="outline-3">
<h3 id="org66e16b2"><span class="section-number-3">0.4.</span> TextMode vs Graphics</h3>
<div class="outline-text-3" id="text-0-4">
<p>
Using Sokol, to build:
</p>

<div class="org-src-container">
<pre class="src src-sh">clang build/third-sokol.c experiments/sokol.m -o build/third-sokol -DSOKOL_METAL -fobjc-arc -Iexperiments/ -framework Metal -framework Cocoa -framework MetalKit -framework Quartz -framework AudioToolbox && build/third-sokol 
</pre>
</div>

<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sokol_app.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sokol_gfx.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sokol_fetch.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sokol_log.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sokol_glue.h&quot;</span><span class="cp"></span>
<span class="cp">#define SOKOL_GL_IMPL</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sokol_gl.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="c1">  // needed by fontstash&#39;s IO functions even though they are not used</span><span class="cp"></span>
<span class="cp">#define FONTSTASH_IMPLEMENTATION</span>
<span class="cp">#if defined(_MSC_VER )</span>
<span class="cp">#pragma warning(disable:4996)   </span><span class="c1">// strncpy use in fontstash.h</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(__GNUC__) || defined(__clang__)</span>
<span class="cp">#pragma GCC diagnostic push</span>
<span class="cp">#pragma GCC diagnostic ignored &quot;-Wunused-function&quot;</span>
<span class="cp">#pragma GCC diagnostic ignored &quot;-Wsign-conversion&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fontstash/fontstash.h&quot;</span><span class="cp"></span>
<span class="cp">#if defined(__GNUC__) || defined(__clang__)</span>
<span class="cp">#pragma GCC diagnostic pop</span>
<span class="cp">#endif</span>
<span class="cp">#define SOKOL_FONTSTASH_IMPL</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sokol_fontstash.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;dbgui/dbgui.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">u8</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">u16</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">u32</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i64</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">u64</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">BufferId</span><span class="p">;</span><span class="w"></span>
<span class="c1">//typedef char[8] Slug; // a short string (≤ 8 bytes)</span>

<span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="n">Success</span><span class="p">,</span><span class="n">Failure</span><span class="p">,</span><span class="n">NotUnicode</span><span class="p">};</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">String</span><span class="p">;</span><span class="w"></span>
<span class="n">String</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// TODO: assert string length</span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">len</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">)};</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">u8</span><span class="w"> </span><span class="nf">to_utf8</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x7F</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x7FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w">            </span><span class="cm">/* 110xxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">          </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span><span class="w">           </span><span class="cm">/* 1110xxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">          </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x10FFFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xF0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">18</span><span class="p">);</span><span class="w">           </span><span class="cm">/* 11110xxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">  </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">          </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Buffer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">BufferId</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="o">*</span><span class="w"> </span><span class="n">contents</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">point</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">line_count</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">line_starts</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span>
<span class="p">}</span><span class="w"> </span><span class="n">Buffer</span><span class="p">;</span><span class="w"></span>

<span class="n">Buffer</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="w"></span>
<span class="n">u16</span><span class="w"> </span><span class="n">buffers_len</span><span class="p">;</span><span class="w"></span>
<span class="n">BufferId</span><span class="w"> </span><span class="n">current_buffer_id</span><span class="p">;</span><span class="w"></span>
<span class="n">Status</span><span class="w"> </span><span class="nf">create_buffer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buffers_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Failure</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffers_len</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Buffer</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_starts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">4096</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Success</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">Status</span><span class="w"> </span><span class="nf">set_current_buffer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buffers_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">current_buffer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Failure</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">Status</span><span class="w"> </span><span class="nf">insert_char</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">contents</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">u64</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">point</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Inserting %d to location %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="w"> </span><span class="n">enc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">u8</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_utf8</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">NotUnicode</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">memmove</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">+</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">loc</span><span class="p">,</span><span class="w"> </span><span class="n">enc</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">point</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">].</span><span class="n">length</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Success</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">handle_event</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sapp_event</span><span class="o">*</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// SAPP_EVENTTYPE_KEY_DOWN</span>
<span class="w">  </span><span class="c1">// SAPP_EVENTTYPE_KEY_UP</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SAPP_EVENTTYPE_CHAR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">insert_char</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">char_code</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// bool key_repeat;</span>
<span class="w">    </span><span class="c1">// uint32_t modifiers;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">FONScontext</span><span class="o">*</span><span class="w"> </span><span class="n">fons</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">dpi_scale</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">font_mono</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">font_normal</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">font_mono_data</span><span class="p">[</span><span class="mi">16</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">font_normal_data</span><span class="p">[</span><span class="mi">256</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">state_t</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">state_t</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">font_mono_loaded</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sfetch_response_t</span><span class="o">*</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loading mono</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">fetched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loaded mono</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">font_mono</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsAddFontMem</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mono&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w">  </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loading mono failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">font_normal_loaded</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sfetch_response_t</span><span class="o">*</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loading normal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">fetched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Loaded normal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">font_normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsAddFontMem</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sans&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w">  </span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* round to next power of 2 (see bit-twiddling-hacks) */</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">round_pow2</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">vi</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">vi</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">vi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">line</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ex</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ey</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_begin_lines</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_c4b</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_v2f</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="n">sy</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_v2f</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span><span class="w"> </span><span class="n">ey</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_end</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">create_buffer</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;*scratch*&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">set_current_buffer</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;*scratch*&quot;</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">dpi_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sapp_dpi_scale</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sg_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sg_desc</span><span class="p">){.</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sapp_sgcontext</span><span class="p">(),</span><span class="w"> </span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">__dbgui_setup</span><span class="p">(</span><span class="n">sapp_sample_count</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sgl_desc_t</span><span class="p">){.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">});</span><span class="w"></span>

<span class="w">  </span><span class="c1">// make sure the fontstash atlas width/height is pow-2</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">atlas_dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round_pow2</span><span class="p">(</span><span class="mf">512.0f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">dpi_scale</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sfons_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfons_desc_t</span><span class="p">){.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atlas_dim</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atlas_dim</span><span class="p">});</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">font_mono</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FONS_INVALID</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">font_normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FONS_INVALID</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">sfetch_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_desc_t</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">num_channels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">num_lanes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">sfetch_send</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_request_t</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/guido/Library/Fonts/MinionPro-Regular.otf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">font_normal_loaded</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SFETCH_RANGE</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">font_normal_data</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">sfetch_send</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sfetch_request_t</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/Users/guido/Library/Fonts/Hack Regular Nerd Font Complete.ttf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">font_mono_loaded</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SFETCH_RANGE</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">font_mono_data</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw_frame</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Buffer</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buffers</span><span class="p">[</span><span class="n">current_buffer_id</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;calculate_line_starts, length = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_starts</span><span class="p">[(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">line_count</span><span class="p">)</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Start of line: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">dpis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">dpi_scale</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="c1">// pump sokol_fetch message queues (GUIDO: why?)</span>
<span class="w">  </span><span class="n">sfetch_dowork</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="n">lh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">white</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sfons_rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsClearState</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">sgl_defaults</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_matrix_mode_projection</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_ortho</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_widthf</span><span class="p">(),</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.0f</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">1.0f</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">sx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="o">*</span><span class="n">dpis</span><span class="p">;</span><span class="w"> </span><span class="n">sy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="o">*</span><span class="n">dpis</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sx</span><span class="p">;</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sy</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">FONScontext</span><span class="o">*</span><span class="w"> </span><span class="n">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetFont</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">font_normal</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetSize</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="mf">124.0f</span><span class="o">*</span><span class="n">dpis</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsVertMetrics</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lh</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sx</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">dy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">lh</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetColor</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">white</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsDrawText</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Draw status line</span>
<span class="w">  </span><span class="n">line</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">()</span><span class="mi">-100</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_widthf</span><span class="p">(),</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">()</span><span class="mi">-100</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetFont</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">font_mono</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fonsSetSize</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="mf">48.0f</span><span class="o">*</span><span class="n">dpis</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fonsDrawText</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sapp_heightf</span><span class="p">()</span><span class="mi">-24</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;U:**-  *scratch*  0% (0,0)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// flush fontstash&#39;s font atlas to sokol-gfx texture</span>
<span class="w">  </span><span class="n">sfons_flush</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// render pass</span>
<span class="w">  </span><span class="n">sg_begin_default_pass</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sg_pass_action</span><span class="p">){</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SG_ACTION_CLEAR</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.32f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">sapp_width</span><span class="p">(),</span><span class="w"> </span><span class="n">sapp_height</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_draw</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">__dbgui_draw</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sg_end_pass</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sg_commit</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">__dbgui_shutdown</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sfetch_shutdown</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sfons_destroy</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">fons</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">sgl_shutdown</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">sg_shutdown</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">sapp_desc</span><span class="w"> </span><span class="nf">sokol_main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">argc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">argv</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sapp_desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">init_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">frame_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">draw_frame</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">cleanup_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cleanup</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">event_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle_event</span><span class="p">,</span><span class="w"> </span><span class="c1">// Or use .event_cb = __dbgui_event,</span>
<span class="w">    </span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">800</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">high_dpi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">gl_force_gles2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">window_title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fontstash&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">icon</span><span class="p">.</span><span class="n">sokol_default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slog_func</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>

<div id="outline-container-org94611c4" class="outline-4">
<h4 id="org94611c4"><span class="section-number-4">0.4.1.</span> Unicode Helpers</h4>
<div class="outline-text-4" id="text-0-4-1">
<div class="org-src-container">
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">String</span><span class="p">;</span><span class="w"></span>
<span class="n">String</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// TODO: assert string length</span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">len</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">)};</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">u8</span><span class="w"> </span><span class="nf">to_utf8</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x7F</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x7FF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xC0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w">            </span><span class="cm">/* 110xxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">          </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span><span class="w">           </span><span class="cm">/* 1110xxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">          </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x10FFFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xF0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">18</span><span class="p">);</span><span class="w">           </span><span class="cm">/* 11110xxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">  </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">);</span><span class="w">          </span><span class="cm">/* 10xxxxxx */</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

</div>
</div>
</div>
</div>


<div id="outline-container-orgec05629" class="outline-3">
<h3 id="orgec05629"><span class="section-number-3">0.5.</span> Extensions</h3>
<div class="outline-text-3" id="text-0-5">
</div>
<div id="outline-container-orgb6ae402" class="outline-4">
<h4 id="orgb6ae402"><span class="section-number-4">0.5.1.</span> Lisp Nodes</h4>
<div class="outline-text-4" id="text-0-5-1">
<p>
The classic C implementation of a Lisp node is an implicit tagged
union of the native word size where the lower 3 bits of a pointer tag
the data that it points to and structs in the array-of-structs style.
</p>

<p>
The modern style is for a struct-of-arrays where we have large
contiguous swaths of identially typed data. We are going to assume a
64 bit native word size here for simplicity. I can think of no good
reason to make this program optimized for other word sizes. If it is
then the hypothetical 32-bit word size advocate is encouraged to fork
this codebase.
</p>

<p>
A block of 64 cells (4096 bytes) is a natural point of segmentation.
This allows flags for all 64 cells to each fit into a single 64 bit
word.
</p>

<div class="org-src-container">
<pre class="src src-c">typedef struct Cons {
  u32 car;
  u32 cde;
} Cons;

typedef struct Cell {
  union {
    i64  n;
    u32  c; // unicode codepoint
    //Slug s;
    Cons p;
  } 
} Cell;

enum Tag {Number, Character, Slug, ConsPair};

Tag  tags[4096];
Cell cells[4096];
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3c9bbaf" class="outline-3">
<h3 id="org3c9bbaf"><span class="section-number-3">0.6.</span> Stupid Ideas</h3>
<div class="outline-text-3" id="text-0-6">
<ul class="org-ul">
<li>Maybe a slug should store 7 bit ascii chars and use the remaining
bits for length?</li>
<li>When loading a file we can write out the text pretty quickly into a
block of cells and then write out the car/cdr parts in a different
part of the block all at once.</li>
</ul>
</div>
</div>

<div id="outline-container-orga5008ba" class="outline-3">
<h3 id="orga5008ba"><span class="section-number-3">0.7.</span> Questions</h3>
<div class="outline-text-3" id="text-0-7">
<ul class="org-ul">
<li>How many ms does it take to redisplay the whole display? Is it less
than an incremental approach on a modern computer?</li>
</ul>
</div>
</div>

<div id="outline-container-org8b74ba3" class="outline-2">
<h2 id="org8b74ba3"><span class="section-number-2">1.</span> Exporting</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgef41ab9" class="outline-4">
<h4 id="orgef41ab9"><span class="section-number-4">1.0.1.</span> Bailing wire and duct tape</h4>
<div class="outline-text-4" id="text-1-0-1">
<div class="org-src-container">
<pre class="src src-python">import re, html
h = html.unescape(open('third.html').read())

from pygments import highlight
from pygments.lexers import CLexer
from pygments.formatters import HtmlFormatter

highlight_c = lambda m: highlight(m.group(1), CLexer(), HtmlFormatter())
r = re.compile(r'<div class="highlight"><pre><span></span><span class="p">(.</span><span class="o">+?</span><span class="p">)</span><span class="w"></span>
</pre></div>
', re.S)
h = r.sub(highlight_c, h)
open('third.html', 'w').write(h)
</pre>
</div>
</div>
</div>




<div id="outline-container-org2cd6687" class="outline-4">
<h4 id="org2cd6687"><span class="section-number-4">1.0.2.</span> Shit that doesn’t work</h4>
<div class="outline-text-4" id="text-1-0-2">
<div class="org-src-container">
<pre class="src src-elisp">;; Path for pygments or command name
(defvar pygments-path "pygmentize")

; pygmentize -l c -f html /tmp/a.c

(defun pygments-org-html-code (code backend info)
  "Ensure \" \" are properly handled in HTML export."
  (when (org-export-derived-backend-p backend 'html)
    (message "The src block's language: %s" (org-element-property :language code))
    (shell-command-to-string (format "pygmentize -l c -f html %s"
                                     (make-temp-file "foo" nil (org-element-property :language code) code)))))

(defun pygments-org-html-code3 (code backend info)
  "Ensure \" \" are properly handled in HTML export."
  (when (org-export-derived-backend-p backend 'html)
    (replace-regexp-in-string "return" "RETURN" code)))

(defun pygments-org-html-code2 (code contents info)
  ;; Generating tmp file path.
  ;; Current date and time hash will ideally pass our needs.
  (setq temp-source-file (format "/tmp/pygmentize-%s.txt"(md5 (current-time-string))))
  ;; Writing block contents to the file.
  (with-temp-file temp-source-file (insert (org-element-property :value code)))
  ;; Exectuing the shell-command an reading an output
  (shell-command-to-string (format "%s -l \"%s\" -f html %s"
				   pygments-path
				   (or (org-element-property :language code)
				       "")
				   temp-source-file)))

;(org-export-define-derived-backend 'guido-html 'html
;  :translate-alist '((src-block .  pygments-org-html-code)
;		     (example-block . pygments-org-html-code)))

(add-to-list 'org-export-filter-src-block-functions
             'pygments-org-html-code)

</pre>
</div>

<ul class="org-ul">
<li class="off"><code>[ ]</code> TODO: It would be cool to be able to show the outside of the buffer struct sorta dimed giving the new code here some context</li>
<li class="off"><code>[ ]</code> TODO: We should also allow you to click on a snippet and see it all merged together</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Guido Bartolucci</p>
<p class="date">Created: 2023-02-27 Mon 12:41</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
